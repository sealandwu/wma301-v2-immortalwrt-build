name: ç¼–è¯‘ ImmortalWrt å›ºä»¶
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      TARGET: mediatek
      SUBTARGET: filogic
      DTS_FILE: mt7981b-wma301-ax3000-v2.dts
      PROFILE: WMA301_AX3000
    steps:
    - name: ğŸ§¹ æ¸…ç†ç©ºé—´
      run: sudo rm -rf /usr/share/dotnet /opt/ghc && docker image prune -af || true

    - name: ğŸ”§ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses-dev zlib1g-dev \
          gawk flex bison openssl libssl-dev gettext libelf-dev \
          device-tree-compiler rsync git-core python3 unzip \
          libtool-bin automake pkg-config ccache

    - name: ğŸ“‚ æ£€æŸ¥ DTS æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      run: |
        echo "ğŸ” å½“å‰ç›®å½•å†…å®¹ï¼š"
        find . -type f | sort
        echo "ğŸ“ æœŸæœ›æ–‡ä»¶ï¼šdts/${DTS_FILE}"
        
        if [ ! -f "dts/${DTS_FILE}" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° dts/${DTS_FILE}"
          echo "ğŸ’¡ è¯·ç¡®è®¤ï¼š"
          echo "   1. æ–‡ä»¶å·²æ”¾å…¥ä»“åº“æ ¹ç›®å½•çš„ dts/ æ–‡ä»¶å¤¹"
          echo "   2. æ–‡ä»¶åå®Œå…¨åŒ¹é…ï¼ˆåŒ…æ‹¬å¤§å°å†™ï¼‰"
          echo "   3. å·²æ‰§è¡Œ git add dts/ && git push"
          echo "   4. .gitignore æœªå¿½ç•¥è¯¥æ–‡ä»¶"
          exit 1
        fi
        echo "âœ… æˆåŠŸæ‰¾åˆ° DTS æ–‡ä»¶ï¼š${DTS_FILE}"

    - name: ğŸ“¥ å…‹éš†æºç 
      run: |
        git clone -b openwrt-23.05 --depth 1 https://github.com/immortalwrt/immortalwrt source
        cd source
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ğŸ“ å¤åˆ¶ DTS
      run: |
        cd source
        mkdir -p target/linux/${TARGET}/dts
        cp ../dts/${DTS_FILE} target/linux/${TARGET}/dts/

    - name: ğŸ”§ æ³¨å†Œæ–°è®¾å¤‡
      run: >-
        DIR="source/target/linux/mediatek/filogic/image";
        MAKEFILE="$DIR/Makefile";
        mkdir -p "$DIR";
        if [ ! -f "$MAKEFILE" ]; then
          echo 'include \$(INCLUDE_DIR)/image.mk' > "$MAKEFILE";
        fi;
        if ! grep -q "define Device/WMA301_AX3000" "$MAKEFILE"; then
          echo 'define Device/WMA301_AX3000' >> "$MAKEFILE";           echo '  $(Device/filogic)' >> "$MAKEFILE";           echo '  DEVICE_VENDOR := Wma301' >> "$MAKEFILE";           echo '  DEVICE_MODEL := mt7981b-wma301-ax3000' >> "$MAKEFILE";           echo '  DEVICE_DTS := mt7981b-wma301-ax3000-v2' >> "$MAKEFILE";           echo '  DEVICE_PACKAGES := wpad-basic-mbedtls kmod-leds-gpio kmod-input-gpio-buttons kmod-mt7915 kmod-mt7531ae luci relayd odhcpd-ipv6only samba36-server kmod-usb-printer kmod-of-mediatek-pinctrl' >> "$MAKEFILE";           echo '  SUPPORTED_DEVICES += mt7981b-wma301-ax3000-v2' >> "$MAKEFILE";           echo 'endef' >> "$MAKEFILE";           echo 'TARGET_DEVICES += WMA301_AX3000' >> "$MAKEFILE"
        fi

    - name: ğŸ›ï¸ ç”Ÿæˆé…ç½®
      run: |
        cd source
        touch .config
        echo 'CONFIG_TARGET_mediatek=y' >> .config
        echo 'CONFIG_TARGET_mediatek_filogic=y' >> .config
        echo 'CONFIG_TARGET_mediatek_filogic_DEVICE_WMA301_AX3000=y' >> .config
        echo 'CONFIG_PACKAGE_u-boot-mediatek=y' >> .config
        echo 'CONFIG_PACKAGE_u-boot-mediatek-images=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-leds-gpio=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-input-gpio-buttons=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-of-mediatek-pinctrl=y' >> .config
        echo 'CONFIG_PACKAGE_luci=y' >> .config
        echo 'CONFIG_PACKAGE_relayd=y' >> .config
        echo 'CONFIG_PACKAGE_odhcpd-ipv6only=y' >> .config
        echo 'CONFIG_PACKAGE_samba36-server=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-usb-printer=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-mt7915=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-mt7915=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-mt7531ae=y' >> .config
        make defconfig

    - name: ğŸ—ï¸ ç¼–è¯‘å›ºä»¶
      run: |
        cd source
        make -j$(nproc) V=s

    - name: ğŸ” æ£€æŸ¥å›ºä»¶å¤§å°
      run: |
        for f in source/bin/targets/*/*/openwrt-*-*-squashfs-sysupgrade.bin; do
          [ -f "$f" ] || continue
          sz=$(stat -c%s "$f")
          echo "$f -> $sz å­—èŠ‚"
          if [ $sz -gt 134217728 ]; then
            echo "âŒ å›ºä»¶è¶…å‡º 128MB é™åˆ¶"
            exit 1
          fi
        done

    - name: ğŸ“¦ ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.run_number }}
        path: source/bin/targets/${TARGET}/${SUBTARGET}/**
        retention-days: 90